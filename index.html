<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Certificate Validation System</title>

  <!-- FLATPICKR CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

  <style>
    :root {
      --field-height: 40px; /* adjust if inputs are taller */
      --field-gap: 10px;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .public-section {
      border-color: #28a745;
      background-color: #f8fff9;
    }

    .admin-section {
      border-color: #dc3545;
      background-color: #fff8f8;
    }

    .owner-section {
      border-color: #fd7e14;
      background-color: #fff8f2;
    }

    input,
    button {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }

    /* Ensure consistent field heights for alignment */
    .admin-grid input[type="text"],
    .admin-grid input[type="date"],
    .admin-grid button {
      height: var(--field-height);
    }

    /* make admin columns consistent */
    .admin-grid > div {
      display: flex;
      flex-direction: column;
      gap: var(--field-gap);
    }

    input[type="text"] {
      min-width: 250px;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover:not(:disabled) {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .verify-btn {
      background-color: #28a745;
    }

    .verify-btn:hover {
      background-color: #218838;
    }

    .danger-btn {
      background-color: #dc3545;
    }

    .danger-btn:hover {
      background-color: #c82333;
    }

    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-icon {
      font-size: 24px;
      margin-right: 10px;
    }

    .network-info {
      background-color: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .certificate-details {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .certificate-details h4 {
      margin-top: 0;
      color: #495057;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #dee2e6;
    }

    .detail-label {
      font-weight: bold;
      color: #6c757d;
    }

    .detail-value {
      color: #495057;
      word-break: break-all;
    }

    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .admin-card {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    /* invisible spacer element to align fields */
    .admin-grid .spacer {
      height: calc((var(--field-height) * 3) + (var(--field-gap) * 2));
      visibility: hidden;
      pointer-events: none;
      margin: 0;
      padding: 0;
    }

    /* Ensure flatpickr calendar appears on top of page UI */
    .flatpickr-calendar {
      z-index: 99999 !important;
    }

    @media (max-width: 768px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }

      input[type="text"] {
        min-width: 200px;
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Certificate Validation System</h1>

    <div class="network-info" id="networkInfo">
      <strong>üì° Network Status:</strong> Connecting to blockchain...
    </div>

    <!-- PUBLIC SECTION - No wallet needed -->
    <div class="section public-section">
      <div class="section-header">
        <span class="section-icon">üîç</span>
        <h2>Public Certificate Verification</h2>
      </div>
      <p><strong>No wallet connection required</strong> - Anyone can verify certificates</p>

      <div style="margin-bottom: 15px;">
        <input type="text" id="verifyCertId" placeholder="Enter Certificate ID to verify" style="width: 300px;">
        <button class="verify-btn" onclick="verifyCert()">üîé Verify Certificate</button>
      </div>

      <div class="loading" id="verifyLoading">
        <div class="spinner"></div>
        <p>Verifying certificate...</p>
      </div>

      <div id="verificationResult"></div>
    </div>

    <!-- ADMIN SECTION - Wallet required -->
    <div class="section admin-section">
      <div class="section-header">
        <span class="section-icon">üë®‚Äçüíº</span>
        <h2>Admin - Issue Certificates</h2>
      </div>
      <p><strong>Wallet connection required</strong> - Only admins can issue certificates</p>

      <div id="walletSection">
        <div id="connectionStatus" class="status warning">
          <strong>Wallet Not Connected</strong><br>
          Connect your MetaMask wallet to issue certificates
        </div>
        <div id="adminStatusControls" style="display: none; margin-top: 10px;">
          <button id="refreshAdminStatus" onclick="checkAdminStatus(true)" style="background-color: #17a2b8;">
            Refresh My Admin Status
          </button>
          <small style="display: block; margin-top: 5px; color: #6c757d;">
            Click to refresh your admin permissions if they have been changed
          </small>
        </div>

        <button id="connectWallet">Connect MetaMask</button>

        <div id="adminControls" style="display: none; margin-top: 20px;">
          <h3>Issue New Certificate</h3>
          <div class="admin-grid">
            <div>
              <input type="text" id="productName" placeholder="Product Name" style="width: 100%;">
              <input type="text" id="mfgName" placeholder="Manufacturer Name" style="width: 100%;">
              <input type="text" id="mfgDate" placeholder="Manufacturer Date" style="width: 100%;">
              <input type="text" id="certificateId" placeholder="Certificate ID" style="width: 100%;">
              <button id="issueCertBtn" onclick="issueCert()" disabled style="width: 100%;">üìú Issue
                Certificate</button>
            </div>
            <div>
              <!-- spacer aligns the revoke input with the left column Certificate ID -->
              <div class="spacer"></div>

              <h4 style="margin: 0 0 4px 0;">Revoke Certificate</h4>
              <input type="text" id="revokeCertId" placeholder="Certificate ID to revoke" style="width: 100%;">
              <button onclick="revokeCert()" style="width: 100%;" class="danger-btn">üóëÔ∏è Revoke Certificate</button>
            </div>
          </div>
        </div>

        <div class="loading" id="issueLoading">
          <div class="spinner"></div>
          <p>Processing transaction...</p>
        </div>
      </div>
    </div>

    <!-- OWNER SECTION - Admin Management -->
    <div class="section owner-section" id="ownerSection" style="display: none;">
      <div class="section-header">
        <span class="section-icon">üë®‚Äçüíº</span>
        <h2>Owner - Admin Management</h2>
      </div>
      <p><strong>Owner Only</strong> - Manage admin accounts</p>

      <div id="adminManagement">
        <div id="adminList" class="info status">
          Loading admin information...
        </div>

        <div class="admin-grid">
          <div class="admin-card">
            <h3>‚ûï Add New Admin</h3>
            <input type="text" id="newAdminAddress" placeholder="Enter admin address (0x...)" style="width: 100%;">
            <button onclick="addNewAdmin()" style="width: 100%;">‚ûï Add Admin</button>
          </div>

          <div class="admin-card">
            <h3>‚ûñ Remove Admin</h3>
            <input type="text" id="removeAdminAddress" placeholder="Enter admin address (0x...)" style="width: 100%;">
            <button onclick="removeAdmin()" style="width: 100%;" class="danger-btn">‚ûñ Remove Admin</button>
          </div>
        </div>

        <div class="admin-card" style="margin-top: 20px;">
          <h3>üîç Check Admin Status</h3>
          <input type="text" id="checkAdminAddress" placeholder="Enter address to check (0x...)" style="width: 70%;">
          <button onclick="checkSpecificAdmin()">üîç Check</button>
          <div id="adminCheckResult" style="margin-top: 10px;"></div>
        </div>

        <div class="loading" id="adminLoading">
          <div class="spinner"></div>
          <p>Processing admin operation...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Ethers.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Your application logic (app.js) -->
  <script src="app.js"></script>

  <!-- FLATPICKR JS and minimal initializer -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      try {
        if (typeof flatpickr === 'undefined') return;
        var el = document.getElementById('mfgDate');
        if (!el) return;

        flatpickr(el, {
          dateFormat: "Y-m-d",  // machine-friendly value
          altInput: true,
          altFormat: "d M Y",   // display: 08 Sep 2025
          maxDate: "today",
          allowInput: true,
          appendTo: document.body,
          onOpen: function (_, __, instance) {
            if (instance && instance.calendarContainer) {
              instance.calendarContainer.style.zIndex = 99999;
            }
          }
        });
      } catch (e) {
        console.warn('Flatpickr init error:', e);
      }
    });
  </script>
</body>

</html>
